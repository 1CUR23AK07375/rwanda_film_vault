{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visitor Dashboard ‚Äî Rwanda Film Vault</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet + markercluster + heat CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background: #f0f4ff; padding: 20px; font-family: 'Inter', Arial, sans-serif; }
        h1 { color: #0d6efd; }
        .badge-online { background-color: #28a745; color: #fff; }
        .badge-offline { background-color: #fd7e14; color: #fff; }
        .table thead { background-color: #0d6efd; color: #fff; }
        .table tbody tr:hover { background-color: rgba(13,110,253,0.04); }
        .stats-card { border-radius: 12px; padding: 18px; box-shadow: 0 6px 18px rgba(10,20,40,0.06); color: #fff; margin-bottom: 20px; }
        .stats-card .icon { font-size: 28px; opacity: 0.9; }
        .stats-card.visits { background: linear-gradient(135deg,#1e3a8a,#0d6efd); }
        .stats-card.online { background: linear-gradient(135deg,#16a34a,#28a745); }
        .stats-card.offline { background: linear-gradient(135deg,#f97316,#fd7e14); }

        #map { border-radius: 12px; border: 2px solid #0d6efd; height:400px; }

        /* Controls for map */
        .map-controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .map-toggle { cursor:pointer; user-select:none; padding:6px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.04); }
        .map-toggle.active { box-shadow: inset 0 -3px 0 rgba(13,110,253,0.12); border-color:#0d6efd; }
        .legend { margin-top:10px; font-size:13px; color:#0f1724; }

        .small-muted { font-size:13px; color:#6b7280; }

        /* layout tweaks */
        .back-link { margin-bottom: 20px; display: inline-block; color: #0d6efd; text-decoration: none; font-weight: 600; }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="container mt-4">
    <a href="{% url 'admin:index' %}" class="back-link">&#8592; Back to Admin Dashboard</a>

    <h1 class="text-center mb-3">Visitor Dashboard</h1>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card visits text-center">
                <div class="icon mb-2">üë•</div>
                <div class="small-muted">Total Visitors</div>
                <div id="total-visitors" style="font-size:22px; font-weight:700">0</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card online text-center">
                <div class="icon mb-2">üü¢</div>
                <div class="small-muted">Online Visitors</div>
                <div id="online-visitors" style="font-size:22px; font-weight:700">0</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card offline text-center">
                <div class="icon mb-2">üî∂</div>
                <div class="small-muted">Offline Visitors</div>
                <div id="offline-visitors" style="font-size:22px; font-weight:700">0</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="mb-3 d-flex gap-2">
        <input type="text" id="visitor-search" class="form-control" placeholder="Search visitors by Name, IP, Country, City...">
        <button id="refresh-button" class="btn btn-outline-primary">Refresh</button>
    </div>

    <!-- Visitor Table -->
    <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped text-center" id="visitors-table">
            <thead>
                <tr>
                    <th>Name / IP</th>
                    <th>Country</th>
                    <th>City</th>
                    <th>Status</th>
                    <th>Visit Count</th>
                    <th>Last Visit</th>
                    <th>Last Watched Movie</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Charts & Map -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>Daily Visits (Last 7 Days)</div>
                    <small class="small-muted">auto-updates</small>
                </div>
                <div class="card-body">
                    <canvas id="daily-visits-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <div>Visitors by Country</div>
                    <small class="small-muted">top countries</small>
                </div>
                <div class="card-body">
                    <canvas id="country-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Map with controls -->
    <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <div>Visitor Map</div>
            <div class="map-controls">
                <div id="toggle-cluster" class="map-toggle active" title="Toggle clusters">Clusters</div>
                <div id="toggle-heat" class="map-toggle" title="Toggle heatmap">Heatmap</div>
                <div id="fit-to-markers" class="map-toggle" title="Fit map to markers">Fit to markers</div>
            </div>
        </div>
        <div class="card-body">
            <div id="map"></div>
            <div class="legend">
                <span style="display:inline-block;width:12px;height:12px;background:#28a745;border-radius:50%;margin-right:6px"></span> Online
                &nbsp;&nbsp;
                <span style="display:inline-block;width:12px;height:12px;background:#fd7e14;border-radius:50%;margin-right:6px"></span> Offline
                &nbsp;&nbsp;
                <span class="small-muted">Markers are clustered; use the zoom controls to expand clusters.</span>
            </div>
        </div>
    </div>

    <div class="mt-4 text-end">
<a href="{% url 'movies:home' %}" class="btn btn-primary">‚Üê Back to Home</a>

    </div>
</div>

<!-- Scripts: Leaflet core, markercluster, heat -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
/* ---------- Utilities ---------- */
function safeText(s){ return (s === null || s === undefined) ? '' : String(s); }
function fmt(n){ try{ return new Intl.NumberFormat().format(Math.round(n)); }catch(e){ return String(n); } }

/* Global visitor cache for filtering */
let allVisitors = [];

/* ---------- Summary / table / charts ---------- */
async function loadVisitors() {
    try {
       const res = await fetch("{% url 'movies:visitor_stats_api' %}");

        const data = await res.json();
        allVisitors = data.visitors || []; // save globally

        // summary
        const total = allVisitors.length || 0;
        const onlineCount = allVisitors.filter(v => v.online).length;
        const offlineCount = total - onlineCount;
        document.getElementById('total-visitors').textContent = fmt(total);
        document.getElementById('online-visitors').textContent = fmt(onlineCount);
        document.getElementById('offline-visitors').textContent = fmt(offlineCount);

        renderVisitorTable(); // render with current filter
        await populateMap(); // uses visitor_map_data endpoint
    } catch (err) {
        console.error("Failed to load visitors:", err);
    }
}

/* ---------- Render table with search filter ---------- */
function renderVisitorTable(){
    const query = document.getElementById('visitor-search').value.toLowerCase();
    const tbody = document.querySelector("#visitors-table tbody");
    tbody.innerHTML = "";

    allVisitors
      .filter(v => {
          const text = `${safeText(v.name)} ${safeText(v.ip)} ${safeText(v.country)} ${safeText(v.city)}`.toLowerCase();
          return text.includes(query);
      })
      .forEach(v => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
              <td>${safeText(v.name)}</td>
              <td>${safeText(v.country)}</td>
              <td>${safeText(v.city)}</td>
              <td>
                <span class="${v.online ? 'badge-online' : 'badge-offline'} py-1 px-2" style="border-radius:6px;">
                  ${v.online ? 'üü¢ Online' : 'üî∂ Offline'}
                </span>
              </td>
              <td>${fmt(v.visit_count)}</td>
              <td>${safeText(v.last_visit)}</td>
              <td>${safeText(v.last_movie)}</td>
          `;
          tbody.appendChild(tr);
      });
}

/* ---------- Charts ---------- */
async function loadCharts(){
    try {
      const dailyRes = await fetch("{% url 'movies:visitor_chart_data' %}");

        const dailyData = await dailyRes.json();
        const ctx1 = document.getElementById('daily-visits-chart').getContext('2d');
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: dailyData.data.map(d => d.date),
                datasets: [{
                    label: 'Visits',
                    data: dailyData.data.map(d => d.count),
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13,110,253,0.12)',
                    fill: true,
                    tension: 0.3,
                }]
            },
            options: { responsive: true, plugins:{legend:{display:false}} }
        });

      const countryRes = await fetch("{% url 'movies:visitor_country_data' %}");

        const countryData = await countryRes.json();
        const ctx2 = document.getElementById('country-chart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: countryData.data.map(d => d.country || 'Unknown'),
                datasets: [{
                    label: 'Visitors',
                    data: countryData.data.map(d => d.count),
                    backgroundColor: '#f97316'
                }]
            },
            options: { responsive: true, plugins:{legend:{display:false}} }
        });

    } catch (err) {
        console.error("Failed to load charts:", err);
    }
}

/* ---------- Map ---------- */
let map, markersCluster, heatLayerCurrent;
async function initMap(){
    map = L.map('map', { preferCanvas: true }).setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    markersCluster = L.markerClusterGroup({ chunkedLoading: true, removeOutsideVisibleBounds: true });
    heatLayerCurrent = L.heatLayer([], { radius: 25, blur: 15, maxZoom: 10 });

    map.addLayer(markersCluster);

    document.getElementById('toggle-cluster').addEventListener('click', function(){
        this.classList.toggle('active');
        if(this.classList.contains('active')) map.addLayer(markersCluster); else map.removeLayer(markersCluster);
    });

    document.getElementById('toggle-heat').addEventListener('click', function(){
        this.classList.toggle('active');
        if(this.classList.contains('active')) map.addLayer(heatLayerCurrent); else map.removeLayer(heatLayerCurrent);
    });

    document.getElementById('fit-to-markers').addEventListener('click', fitMapToMarkers);
    document.getElementById('refresh-button').addEventListener('click', loadVisitors);
    document.getElementById('visitor-search').addEventListener('input', renderVisitorTable);
}

async function populateMap(){
    if(!map) await initMap();
    try {
        const res = await fetch("{% url 'movies:visitor_map_data' %}");

        const payload = await res.json();
        const rows = payload.data || [];

        markersCluster.clearLayers();
        heatLayerCurrent.setLatLngs([]);
        const heatPoints = [];

        rows.forEach(v => {
            const lat = parseFloat(v.lat);
            const lng = parseFloat(v.lng);
            if (!isFinite(lat) || !isFinite(lng)) return;
            if (Math.abs(lat) < 1e-6 && Math.abs(lng) < 1e-6) return;

            const popupHtml = `
                <div style="min-width:160px">
                  <div><strong>${safeText(v.ip)}</strong></div>
                  <div class="small-muted">${safeText(v.city)} ${v.city && v.country ? ',' : ''} ${safeText(v.country)}</div>
                  <div style="margin-top:6px"><strong>${v.online ? 'üü¢ Online' : 'üî∂ Offline'}</strong></div>
                </div>
            `;

            const marker = L.marker([lat, lng], { title: v.ip });
            marker.bindPopup(popupHtml);
            markersCluster.addLayer(marker);

            const weight = (v.visit_count && !isNaN(v.visit_count) ? Math.max(0.2, Math.min(5, v.visit_count)) : 0.8);
            heatPoints.push([lat, lng, weight]);
        });

        heatLayerCurrent.setLatLngs(heatPoints);
        fitMapToMarkers();
    } catch (err) {
        console.error("Failed to populate map:", err);
    }
}

function fitMapToMarkers(){
    try {
        const bounds = markersCluster.getBounds();
        if (bounds && bounds.isValid && bounds.isValid()) map.fitBounds(bounds.pad(0.15), { animate: true });
        else map.setView([0,0],2);
    } catch (e) {
        console.warn("fitMapToMarkers error:", e);
    }
}

/* ---------- Init everything ---------- */
(async function main(){
    await initMap();
    await loadVisitors();
    await loadCharts();
    setInterval(loadVisitors, 10000);
})();
</script>
</body>
</html>
